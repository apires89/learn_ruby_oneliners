<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Processing structured data - Ruby one-liners cookbook</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Example based guide for text processing with ruby from the command line">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="custom.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="cover.html">Cover</a></li><li class="chapter-item expanded affix "><a href="buy.html">Buy PDF/EPUB versions</a></li><li class="chapter-item expanded "><a href="preface.html"><strong aria-hidden="true">1.</strong> Preface</a></li><li class="chapter-item expanded "><a href="one-liner-introduction.html"><strong aria-hidden="true">2.</strong> One-liner introduction</a></li><li class="chapter-item expanded "><a href="line-processing.html"><strong aria-hidden="true">3.</strong> Line processing</a></li><li class="chapter-item expanded "><a href="field-separators.html"><strong aria-hidden="true">4.</strong> Field separators</a></li><li class="chapter-item expanded "><a href="record-separators.html"><strong aria-hidden="true">5.</strong> Record separators</a></li><li class="chapter-item expanded "><a href="multiple-file-input.html"><strong aria-hidden="true">6.</strong> Multiple file input</a></li><li class="chapter-item expanded "><a href="processing-multiple-records.html"><strong aria-hidden="true">7.</strong> Processing multiple records</a></li><li class="chapter-item expanded "><a href="two-file-processing.html"><strong aria-hidden="true">8.</strong> Two file processing</a></li><li class="chapter-item expanded "><a href="dealing-with-duplicates.html"><strong aria-hidden="true">9.</strong> Dealing with duplicates</a></li><li class="chapter-item expanded "><a href="processing-structured-data.html" class="active"><strong aria-hidden="true">10.</strong> Processing structured data</a></li><li class="chapter-item expanded "><a href="Exercise_solutions.html"><strong aria-hidden="true">11.</strong> Exercise Solutions</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Ruby one-liners cookbook</h1>

                    <div class="right-buttons">
                        
                        <a href="https://github.com/learnbyexample/learn_ruby_oneliners" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#processing-structured-data" id="processing-structured-data">Processing structured data</a></h1>
<p>All the examples in previous chapters dealt with simple text formats separated by newline or some other sequence of characters. Such data could be linearly read and processed. However, formats like <code>json</code>, <code>csv</code>, <code>xml</code> and <code>html</code> have a specific structure that requires a custom parser before they can be made available for further processing. This chapter will give a brief overview of libraries to parse such structured inputs.</p>
<h2><a class="header" href="#json" id="json">JSON</a></h2>
<p>The <code>JSON</code> built-in module helps you to process <code>json</code> data by converting it to a Ruby <code>hash</code> object. See <a href="https://ruby-doc.org/stdlib-2.7.1/libdoc/json/rdoc/JSON.html">ruby-doc: JSON</a> for documentation.</p>
<p>Here's an example of converting possibly minified <code>json</code> input to a pretty printed output.</p>
<pre><code class="language-bash">$ s='{&quot;greeting&quot;:&quot;hi&quot;,&quot;marks&quot;:[78,62,93]}'

# ARGF.read is an alternate for -0777 option to slurp entire input
$ echo &quot;$s&quot; | ruby -rjson -e 'ip = JSON.parse(ARGF.read);
                   puts JSON.pretty_generate(ip)'
{
  &quot;greeting&quot;: &quot;hi&quot;,
  &quot;marks&quot;: [
    78,
    62,
    93
  ]
}
</code></pre>
<p>You can create a shortcut to make it easier for one-liners.</p>
<pre><code class="language-bash">$ # check if shortcut is available
$ type rq
bash: type: rq: not found

$ # add this to your ~/.bashrc (or the file you use for aliases/functions)
$ rq() { ruby -rjson -e 'ip = JSON.parse(ARGF.read);'&quot;$@&quot; ; }

$ s='{&quot;greeting&quot;:&quot;hi&quot;,&quot;marks&quot;:[78,62,93]}'

$ # get value of given key
$ echo &quot;$s&quot; | rq 'puts ip[&quot;greeting&quot;]'
hi
$ # you can even pass options after the code snippet
$ echo &quot;$s&quot; | rq 'print ip[&quot;marks&quot;]' -l
[78, 62, 93]

$ # use JSON.pretty_generate(ip) if you need pretty output
$ echo &quot;$s&quot; | rq 'ip[&quot;marks&quot;][1] = 100; puts JSON.generate(ip)'
{&quot;greeting&quot;:&quot;hi&quot;,&quot;marks&quot;:[78,100,93]}
</code></pre>
<p>Here's another example.</p>
<pre><code class="language-bash">$ cat sample.json
{
    &quot;fruit&quot;: &quot;apple&quot;,
    &quot;blue&quot;: [&quot;toy&quot;, &quot;flower&quot;, &quot;sand stone&quot;],
    &quot;light blue&quot;: [&quot;flower&quot;, &quot;sky&quot;, &quot;water&quot;],
    &quot;language&quot;: {
        &quot;natural&quot;: [&quot;english&quot;, &quot;hindi&quot;, &quot;spanish&quot;],
        &quot;programming&quot;: [&quot;python&quot;, &quot;kotlin&quot;, &quot;ruby&quot;]
    },
    &quot;physics&quot;: 84
}

$ # process top-level keys not containing 'e'
$ rq 'ip.each {|k,v| puts &quot;#{k}:#{v}&quot; if !k.match?(/e/)}' sample.json
fruit:apple
physics:84

$ # process keys within 'language' key that contain 't'
$ rq 'ip[&quot;language&quot;].each {|k,v| puts &quot;#{k}:#{v}&quot; if k.match?(/t/)}' sample.json
natural:[&quot;english&quot;, &quot;hindi&quot;, &quot;spanish&quot;]
</code></pre>
<h2><a class="header" href="#csv" id="csv">CSV</a></h2>
<p>The <code>CSV</code> built-in class comes in handy for processing <code>csv</code> files. See <a href="https://ruby-doc.org/stdlib-2.7.1/libdoc/csv/rdoc/CSV.html">ruby-doc: CSV</a> for documentation.</p>
<p>Here's a simple example that parses entire input string in one shot.</p>
<pre><code class="language-bash">$ s='eagle,&quot;fox,42&quot;,bee,frog\n1,2,3,4'

$ printf '%b' &quot;$s&quot; | ruby -rcsv -le 'ip=CSV.new(ARGF.read); print ip.read'
[[&quot;eagle&quot;, &quot;fox,42&quot;, &quot;bee&quot;, &quot;frog&quot;], [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;]]

$ printf '%b' &quot;$s&quot; | ruby -rcsv -e 'ip=CSV.new(ARGF.read); puts ip.read[0][1]'
fox,42
</code></pre>
<p>Here's an example with newline character inside quoted fields. This example directly uses the input filename instead of passing it as command line argument to the <code>ruby</code> script.</p>
<pre><code class="language-bash">$ cat newline.csv
apple,&quot;1
2
3&quot;,good
guava,&quot;32
54&quot;,nice

$ # this will parse entire input in one shot
$ ruby -rcsv -le 'ip=CSV.read(&quot;newline.csv&quot;); print ip'
[[&quot;apple&quot;, &quot;1\n2\n3&quot;, &quot;good&quot;], [&quot;guava&quot;, &quot;32\n54&quot;, &quot;nice&quot;]]

$ # this is better suited for large inputs
$ ruby -rcsv -e 'CSV.foreach(&quot;newline.csv&quot;){ |row|
                 puts row[2] if row[0]=~/pp/ }'
good
</code></pre>
<p>You can change field separator using the <code>col_sep</code> option.</p>
<pre><code class="language-bash">
$ ruby -rcsv -e 'CSV.foreach(&quot;marks.txt&quot;, :col_sep =&gt; &quot;\t&quot;){ |r|
                 puts r * &quot;,&quot; if r[0]==&quot;ECE&quot; }'
ECE,Raj,53
ECE,Joel,72
ECE,Om,92
</code></pre>
<p>The <code>headers</code> option will treat the first row as the header, useful for named field processing.</p>
<pre><code class="language-bash">$ ruby -rcsv -e 'CSV.foreach(&quot;marks.txt&quot;, :headers =&gt; true, :col_sep =&gt; &quot;\t&quot;){
                 |r| puts r[&quot;Name&quot;] }'
Raj
Joel
Moi
Surya
Tia
Om
Amy
</code></pre>
<p>You can automatically try to convert field value to given data type(s) using the <code>converters</code> option. See <a href="https://ruby-doc.org/stdlib-2.7.1/libdoc/csv/rdoc/CSV.html#class-CSV-label-Typed+data+reading">ruby-doc: CSV Typed data reading</a> for details.</p>
<pre><code class="language-bash">$ ruby -rcsv -le 'CSV.foreach(&quot;marks.txt&quot;, :converters =&gt; :integer,
                  :col_sep =&gt; &quot;\t&quot;){ print _1 }'
[&quot;Dept&quot;, &quot;Name&quot;, &quot;Marks&quot;]
[&quot;ECE&quot;, &quot;Raj&quot;, 53]
[&quot;ECE&quot;, &quot;Joel&quot;, 72]
[&quot;EEE&quot;, &quot;Moi&quot;, 68]
[&quot;CSE&quot;, &quot;Surya&quot;, 81]
[&quot;EEE&quot;, &quot;Tia&quot;, 59]
[&quot;ECE&quot;, &quot;Om&quot;, 92]
[&quot;CSE&quot;, &quot;Amy&quot;, 67]
</code></pre>
<h2><a class="header" href="#xml-and-html" id="xml-and-html">XML and HTML</a></h2>
<p><a href="https://nokogiri.org/">nokogiri</a> is a popular third-party library to parse <code>xml</code> and <code>html</code> formats. It also supports working with malformed data.</p>
<p>To parse an input, you can either pass the string or pass a filehandle. You can also pass <code>URI</code> filehandle for working with URLs directly.</p>
<p>Both XPath and CSS based selections are available. See also <a href="https://www.w3schools.com/xml/xpath_intro.asp">XPath introduction</a> and <a href="https://johnresig.com/blog/xpath-css-selectors/">difference between XPath and CSS Selectors</a>. Here's some examples with <code>xpath</code> methods.</p>
<pre><code class="language-bash">$ cat sample.xml
&lt;doc&gt;
    &lt;greeting type=&quot;ask&quot;&gt;Hi there. How are you?&lt;/greeting&gt;
    &lt;greeting type=&quot;reply&quot;&gt;I am good.&lt;/greeting&gt;
    &lt;color&gt;
        &lt;blue&gt;flower&lt;/blue&gt;
        &lt;blue&gt;sand stone&lt;/blue&gt;
        &lt;light-blue&gt;sky&lt;/light-blue&gt;
        &lt;light-blue&gt;water&lt;/light-blue&gt;
    &lt;/color&gt;
&lt;/doc&gt;

$ # all results for 'blue' tag
$ # note that ARGF filehandle is passed directly here
$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.xpath(&quot;//blue&quot;)' sample.xml
&lt;blue&gt;flower&lt;/blue&gt;
&lt;blue&gt;sand stone&lt;/blue&gt;

$ # selecting based on content of 'blue' tags
$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.xpath(&quot;//blue&quot;).grep(/stone/)' sample.xml
&lt;blue&gt;sand stone&lt;/blue&gt;

$ # use 'at_xpath' instead of 'xpath' to get only the first result
$ # or use 'ip.xpath(&quot;//blue&quot;)[0]' to get specific elements
$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.at_xpath(&quot;//blue&quot;)' sample.xml
&lt;blue&gt;flower&lt;/blue&gt;
</code></pre>
<p>Here's an example with <code>css</code> methods. Use <code>text</code> method to get the value of the selected tags.</p>
<pre><code class="language-bash">$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.css(&quot;light-blue&quot;).map(&amp;:text)' sample.xml
sky
water

$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.at_css(&quot;blue&quot;).text' sample.xml
flower
</code></pre>
<p>Here's an example of matching attributes.</p>
<pre><code class="language-bash">$ # you can use //@type if you want all attributes that are named as 'type'
$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.xpath(&quot;//greeting/@type&quot;)' sample.xml
ask
reply

$ # match a specific attribute value
$ # same as: ip.css(&quot;greeting[type=\&quot;ask\&quot;]&quot;)
$ ruby -rnokogiri -e 'ip=Nokogiri.XML(ARGF);
        puts ip.xpath(&quot;//greeting[@type=\&quot;ask\&quot;]&quot;).text' sample.xml
Hi there. How are you?
</code></pre>
<p>Here's an example with <code>html</code> input.</p>
<pre><code class="language-bash">$ s='https://learnbyexample.github.io/substitution-with-ripgrep/'
$ url=&quot;$s&quot; ruby -rnokogiri -ropen-uri -e 'ip=Nokogiri.XML(URI.open(ENV[&quot;url&quot;]));
                 puts ip.css(&quot;@href&quot;)[3..5]'
https://learnbyexample.github.io
https://learnbyexample.github.io/books
https://learnbyexample.github.io/tags
</code></pre>
<h2><a class="header" href="#summary" id="summary">Summary</a></h2>
<p>This chapter showed basic examples of processing structured data like <code>json</code>, <code>csv</code>, <code>xml</code> and <code>html</code> using built-in and third-party libraries. As mentioned in the introduction chapter, using <code>ruby</code> one-liners for such tasks helps you avoid learning the syntax and idioms of a custom command line tool. Another advantage is that you have the entire ecosystem of a programming language at disposal once the structured input has been parsed. If performance becomes a concern, then custom cli tools like <a href="https://stedolan.github.io/jq/">jq</a>, <a href="https://github.com/BurntSushi/xsv">xsv</a> and <a href="http://xmlstar.sourceforge.net/doc/UG/xmlstarlet-ug.html">xmlstarlet</a> will come in handy.</p>
<p>No exercises for this final chapter (author is lazy and doesn't have much experience with these formats). So, I'll leave you with links for further reading and as a source of exercises.</p>
<ul>
<li><a href="https://stackoverflow.com/questions/tagged/ruby+json?tab=Votes">stackoverflow: ruby+json</a></li>
<li><a href="https://stackoverflow.com/questions/tagged/ruby+csv?tab=Votes">stackoverflow: ruby+csv</a></li>
<li><a href="https://stackoverflow.com/questions/tagged/ruby+xml?tab=Votes">stackoverflow: ruby+xml</a></li>
<li><a href="https://mosermichael.github.io/jq-illustrated/dir/content.html">Illustrated jq tutorial</a></li>
<li><a href="http://xmlstar.sourceforge.net/doc/UG/xmlstarlet-ug.html">xmlstarlet tutorial</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="dealing-with-duplicates.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="Exercise_solutions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="dealing-with-duplicates.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="Exercise_solutions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
